generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  password      String
  rollNumber    String?        @map("roll_number")
  cgpa          Float?
  backlog       Int?
  cvUrl         String?        @map("cv_url")
  cvData        Bytes?         @map("cv_data")
  phone         String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  applications  Application[]
  notifications Notification[]
  codingSubmissions CodingSubmission[]

  @@index([email])
  @@map("students")
}

model Company {
  id          Int      @id @default(autoincrement())
  companyName String   @map("company_name")
  email       String   @unique
  password    String
  industry    String?
  website     String?
  phone       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  jobs        Job[]

  @@index([email])
  @@map("companies")
}

model Job {
  id                   Int            @id @default(autoincrement())
  title                String
  description          String
  location             String?
  type                 String
  salary               String?
  requiredSkills       String?        @map("required_skills")
  minCgpa              Float?         @map("min_cgpa")
  includeCgpaInShortlisting Boolean?  @default(true) @map("include_cgpa_in_shortlisting")
  allowBacklog         Boolean?       @map("allow_backlog")
  maxBacklog           Int?           @map("max_backlog")
  jobDescriptionFileUrl String?        @map("job_description_file_url")
  deadline              DateTime?      @map("deadline")
  companyId            Int            @map("company_id")
  status               String         @default("OPEN")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")
  applications         Application[]
  interviews           Interview[]
  company              Company        @relation(fields: [companyId], references: [id])
  notifications        Notification[]
  codingTest           CodingTest?

  @@index([companyId])
  @@map("jobs")
}

model Application {
  id             Int            @id @default(autoincrement())
  studentId      Int            @map("student_id")
  jobId          Int            @map("job_id")
  skills         String?        @map("skills")
  cgpa           Float?         @map("cgpa")
  backlog        Int?           @map("backlog")
  cvUrl          String?        @map("cv_url")
  cvData         Bytes?         @map("cv_data")
  decisionReason String?        @map("decision_reason")
  status         String         @default("PENDING")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  job            Job            @relation(fields: [jobId], references: [id])
  student        Student        @relation(fields: [studentId], references: [id])
  interview      Interview?
  notifications  Notification[]

  @@index([studentId])
  @@index([jobId])
  @@map("applications")
}

model Interview {
  id            Int         @id @default(autoincrement())
  applicationId Int         @unique @map("application_id")
  jobId         Int         @map("job_id")
  date          DateTime
  type          String
  status        String      @default("SCHEDULED")
  notes         String?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  application   Application @relation(fields: [applicationId], references: [id])
  job           Job         @relation(fields: [jobId], references: [id])

  @@index([applicationId])
  @@index([jobId])
  @@map("interviews")
}

model Notification {
  id             Int          @id @default(autoincrement())
  studentId      Int          @map("student_id")
  title          String
  message        String
  read           Boolean      @default(false)
  decisionReason String?      @map("decision_reason")
  jobId          Int?         @map("job_id")
  applicationId  Int?         @map("application_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  application    Application? @relation(fields: [applicationId], references: [id])
  job            Job?         @relation(fields: [jobId], references: [id])
  student        Student      @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([read])
  @@map("notifications")
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([username])
  @@map("admins")
}

model CodingTest {
  id            Int              @id @default(autoincrement())
  jobId         Int              @unique @map("job_id")
  title         String
  description   String?
  allowedLanguages String        @map("allowed_languages") // JSON array of language IDs
  timeLimit     Int              @default(60) @map("time_limit") // in minutes
  cutoff        Float?          // minimum score to pass (percentage)
  status        String           @default("CREATED")
  startedAt     DateTime?        @map("started_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  job           Job              @relation(fields: [jobId], references: [id])
  questions     CodingQuestion[]
  submissions   CodingSubmission[]

  @@index([jobId])
  @@map("coding_tests")
}

model CodingQuestion {
  id            Int          @id @default(autoincrement())
  testId        Int          @map("test_id")
  title         String
  description   String       // Problem statement
  difficulty    String       @default("MEDIUM") // EASY, MEDIUM, HARD
  points        Int          @default(10)
  testCases     String       @map("test_cases") // JSON array of test cases
  expectedOutputs String     @map("expected_outputs") // JSON array of expected outputs
  sampleInput   String?      @map("sample_input")
  sampleOutput  String?      @map("sample_output")
  constraints   String?      // Problem constraints
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  test          CodingTest   @relation(fields: [testId], references: [id])

  @@index([testId])
  @@map("coding_questions")
}

model CodingSubmission {
  id            Int            @id @default(autoincrement())
  testId        Int            @map("test_id")
  questionId    Int            @map("question_id")
  studentId     Int            @map("student_id")
  languageId    Int            @map("language_id") // Judge0 language ID
  code          String         // Submitted code
  status        String?        // PENDING, ACCEPTED, WRONG_ANSWER, TIME_LIMIT_EXCEEDED, etc.
  score         Float?         // Score for this question
  executionTime Float?         @map("execution_time") // in seconds
  memoryUsed    Int?           @map("memory_used") // in bytes
  judge0Token   String?        @map("judge0_token") // Judge0 submission token
  errorMessage  String?         @map("error_message")
  testCaseResults String?      @map("test_case_results") // JSON array of test case results
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  test          CodingTest     @relation(fields: [testId], references: [id])
  student       Student        @relation(fields: [studentId], references: [id])

  @@index([testId])
  @@index([questionId])
  @@index([studentId])
  @@map("coding_submissions")
}
