generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  password      String
  rollNumber    String?        @map("roll_number")
  cgpa          Float?
  backlog       Int?
  cvUrl         String?        @map("cv_url")
  cvData        Bytes?         @map("cv_data")
  phone         String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  applications  Application[]
  notifications Notification[]
  codingSubmissions CodingSubmission[]
  aptitudeSubmissions AptitudeSubmission[]

  @@index([email])
  @@map("students")
}

model Company {
  id          Int      @id @default(autoincrement())
  companyName String   @map("company_name")
  email       String   @unique
  password    String
  industry    String?
  website     String?
  phone       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  jobs        Job[]

  @@index([email])
  @@map("companies")
}

model Job {
  id                   Int            @id @default(autoincrement())
  title                String
  description          String
  location             String?
  type                 String
  salary               String?
  requiredSkills       String?        @map("required_skills")
  minCgpa              Float?         @map("min_cgpa")
  includeCgpaInShortlisting Boolean?  @default(true) @map("include_cgpa_in_shortlisting")
  allowBacklog         Boolean?       @map("allow_backlog")
  maxBacklog           Int?           @map("max_backlog")
  jobDescriptionFileUrl String?        @map("job_description_file_url")
  deadline              DateTime?      @map("deadline")
  companyId            Int            @map("company_id")
  status               String         @default("OPEN")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")
  applications         Application[]
  interviews           Interview[]
  company              Company        @relation(fields: [companyId], references: [id])
  notifications        Notification[]
  codingTest           CodingTest?
  aptitudeTest         AptitudeTest?

  @@index([companyId])
  @@map("jobs")
}

model Application {
  id             Int            @id @default(autoincrement())
  studentId      Int            @map("student_id")
  jobId          Int            @map("job_id")
  skills         String?        @map("skills")
  cgpa           Float?         @map("cgpa")
  backlog        Int?           @map("backlog")
  cvUrl          String?        @map("cv_url")
  cvData         Bytes?         @map("cv_data")
  decisionReason String?        @map("decision_reason")
  status         String         @default("PENDING")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  job            Job            @relation(fields: [jobId], references: [id])
  student        Student        @relation(fields: [studentId], references: [id])
  interview      Interview?
  notifications  Notification[]

  @@index([studentId])
  @@index([jobId])
  @@map("applications")
}

model Interview {
  id            Int         @id @default(autoincrement())
  applicationId Int         @unique @map("application_id")
  jobId         Int         @map("job_id")
  date          DateTime
  type          String
  status        String      @default("SCHEDULED")
  notes         String?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  application   Application @relation(fields: [applicationId], references: [id])
  job           Job         @relation(fields: [jobId], references: [id])
  sessions      InterviewSession[]

  @@index([applicationId])
  @@index([jobId])
  @@map("interviews")
}

model InterviewSession {
  id            Int         @id @default(autoincrement())
  interviewId  Int         @map("interview_id")
  mode          String      // "TECH" or "HR"
  status        String      @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  currentQuestionIndex Int  @default(0) @map("current_question_index")
  questions     String      // JSON array of questions
  answers       String?     // JSON array of answers
  startedAt     DateTime    @default(now()) @map("started_at")
  completedAt   DateTime?   @map("completed_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  interview     Interview   @relation(fields: [interviewId], references: [id])
  questionAnswers InterviewQuestionAnswer[]

  @@index([interviewId])
  @@map("interview_sessions")
}

model InterviewQuestionAnswer {
  id                Int            @id @default(autoincrement())
  sessionId         Int            @map("session_id")
  questionIndex     Int            @map("question_index")
  questionText      String         @map("question_text")
  transcribedText   String?        @map("transcribed_text") // Speech-to-Text result
  audioUrl          String?        @map("audio_url") // URL to stored audio file
  videoUrl          String?        @map("video_url") // URL to stored video file
  contentScore      Float?         @map("content_score") // Gemini AI score (0-10)
  confidenceScore   Float?         @map("confidence_score") // Audio analysis (0-10)
  emotionScores     String?        @map("emotion_scores") // JSON: {happy: 0.8, neutral: 0.2, ...}
  overallScore      Float?         @map("overall_score") // Combined score (0-10)
  feedback          String?        // AI-generated feedback
  analysisData      String?        @map("analysis_data") // Full analysis JSON
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  session           InterviewSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@index([questionIndex])
  @@map("interview_question_answers")
}

model Notification {
  id             Int          @id @default(autoincrement())
  studentId      Int          @map("student_id")
  title          String
  message        String
  read           Boolean      @default(false)
  decisionReason String?      @map("decision_reason")
  jobId          Int?         @map("job_id")
  applicationId  Int?         @map("application_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  application    Application? @relation(fields: [applicationId], references: [id])
  job            Job?         @relation(fields: [jobId], references: [id])
  student        Student      @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([read])
  @@map("notifications")
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([username])
  @@map("admins")
}

model CodingTest {
  id            Int              @id @default(autoincrement())
  jobId         Int              @unique @map("job_id")
  title         String
  description   String?
  allowedLanguages String        @map("allowed_languages") // JSON array of language IDs
  timeLimit     Int              @default(60) @map("time_limit") // in minutes
  cutoff        Float?          // minimum score to pass (percentage)
  status        String           @default("CREATED")
  startedAt     DateTime?        @map("started_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  job           Job              @relation(fields: [jobId], references: [id])
  questions     CodingQuestion[]
  submissions   CodingSubmission[]

  @@index([jobId])
  @@map("coding_tests")
}

model CodingQuestion {
  id            Int          @id @default(autoincrement())
  testId        Int          @map("test_id")
  title         String
  description   String       // Problem statement
  difficulty    String       @default("MEDIUM") // EASY, MEDIUM, HARD
  points        Int          @default(10)
  testCases     String       @map("test_cases") // JSON array of test cases
  expectedOutputs String     @map("expected_outputs") // JSON array of expected outputs
  sampleInput   String?      @map("sample_input")
  sampleOutput  String?      @map("sample_output")
  constraints   String?      // Problem constraints
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  test          CodingTest   @relation(fields: [testId], references: [id])

  @@index([testId])
  @@map("coding_questions")
}

model CodingSubmission {
  id            Int            @id @default(autoincrement())
  testId        Int            @map("test_id")
  questionId    Int            @map("question_id")
  studentId     Int            @map("student_id")
  languageId    Int            @map("language_id") // Judge0 language ID
  code          String         // Submitted code
  status        String?        // PENDING, ACCEPTED, WRONG_ANSWER, TIME_LIMIT_EXCEEDED, etc.
  score         Float?         // Score for this question
  executionTime Float?         @map("execution_time") // in seconds
  memoryUsed    Int?           @map("memory_used") // in bytes
  judge0Token   String?        @map("judge0_token") // Judge0 submission token
  errorMessage  String?         @map("error_message")
  testCaseResults String?      @map("test_case_results") // JSON array of test case results
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  test          CodingTest     @relation(fields: [testId], references: [id])
  student       Student        @relation(fields: [studentId], references: [id])

  @@index([testId])
  @@index([questionId])
  @@index([studentId])
  @@map("coding_submissions")
}

model AptitudeTest {
  id            Int                @id @default(autoincrement())
  jobId         Int                @unique @map("job_id")
  sections      Json               // JSON array of sections
  cutoff        Int?
  totalQuestions Int?              @map("total_questions")
  status        String             @default("CREATED")
  startedAt     DateTime?          @map("started_at")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  job           Job                @relation(fields: [jobId], references: [id])
  questions     AptitudeQuestion[]
  submissions   AptitudeSubmission[]

  @@index([jobId])
  @@map("aptitude_tests")
}

model AptitudeQuestion {
  id            Int          @id @default(autoincrement())
  testId        Int          @map("test_id")
  section       String
  questionText  String       @map("question_text")
  options       Json         // JSON array of options
  correctIndex  Int          @map("correct_index")
  marks         Int          @default(1)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  test          AptitudeTest @relation(fields: [testId], references: [id])

  @@index([testId])
  @@map("aptitude_questions")
}

model AptitudeSubmission {
  id            Int            @id @default(autoincrement())
  testId        Int            @map("test_id")
  studentId     Int            @map("student_id")
  answers       Json           // JSON object mapping question IDs to selected answers
  score         Float?
  percentage    Float?
  status        String?        // PASSED, FAILED, etc.
  submittedAt   DateTime?      @map("submitted_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  test          AptitudeTest   @relation(fields: [testId], references: [id])
  student       Student        @relation(fields: [studentId], references: [id])

  @@index([testId])
  @@index([studentId])
  @@map("aptitude_submissions")
}
